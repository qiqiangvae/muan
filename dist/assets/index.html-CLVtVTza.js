import{_ as i,c as a,e,o as n}from"./app-DN5qPkk5.js";const l={};function t(d,s){return n(),a("div",null,s[0]||(s[0]=[e(`<h2 id="redis-基础" tabindex="-1"><a class="header-anchor" href="#redis-基础"><span>Redis 基础</span></a></h2><p>Redis 是一个开源的内存结构存储系统。可作于<strong>数据库</strong>、<strong>缓存</strong>和<strong>消息中间件</strong>等。</p><h3 id="数据类型" tabindex="-1"><a class="header-anchor" href="#数据类型"><span>数据类型</span></a></h3><table><thead><tr><th style="text-align:center;">数据类型</th><th>说明</th></tr></thead><tbody><tr><td style="text-align:center;">String</td><td>字符串</td></tr><tr><td style="text-align:center;">Hash</td><td>散列，相当于 Java 中的 Map</td></tr><tr><td style="text-align:center;">List</td><td>列表</td></tr><tr><td style="text-align:center;">Set</td><td>集合。Set 本质是一个特殊的 Hash，他的 Value 为空</td></tr><tr><td style="text-align:center;">ZSet</td><td>有序集合</td></tr><tr><td style="text-align:center;">BitMap</td><td>本质是 String，因为 String 最大长度是 512M，所以BitMap最多可存储2^32个bit</td></tr></tbody></table><h3 id="单机搭建" tabindex="-1"><a class="header-anchor" href="#单机搭建"><span>单机搭建</span></a></h3><ol><li><p>下载 tar 包到 /opt 目录下并安装。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">wget</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> https://download.redis.io/releases/redis-5.0.5.tar.gz</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">tar</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> xzf</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> redis-5.0.5.tar.gz</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mv</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> redis-5.0.5</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> redis</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> redis/</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">make</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> install</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此时 redis 已经安装好了，可以查看。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ls</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/local/bin/redis-</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">*</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>可以看到一些执行文件</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>/usr/local/bin/redis-benchmark  /usr/local/bin/redis-check-rdb  /usr/local/bin/redis-sentinel</span></span>
<span class="line"><span>/usr/local/bin/redis-check-aof  /usr/local/bin/redis-cli        /usr/local/bin/redis-server</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>创建工作空间并复制配置文件。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mkdir</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /redis/singleton</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> &amp;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> cp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/redis/redis.conf</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /redis/singleton/</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>修改配置文件。</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 改为内网ip，连接时可以通过外网连接</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">bind 10.255.0.xxx</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 设置密码</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">requirepass jonkee</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 以守护进程启动</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">daemonize yes</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 日志文件</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">logfile </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/redis/singleton/redis.log</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>启动 redis。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">/usr/local/bin/redis-server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> redis.conf</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>启动完成，可以通过命令行客户端连接，也可以用其它客户端通过外网连接。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">/usr/local/bin/redis-cli</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -h</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 10.255.0.xxx</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -a</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> jonkee</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>测试命令和执行结果如下：</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>10.255.0.111:6379&gt; set name muan</span></span>
<span class="line"><span>OK</span></span>
<span class="line"><span>10.255.0.111:6379&gt; get name</span></span>
<span class="line"><span>&quot;muan&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h3 id="客户端" tabindex="-1"><a class="header-anchor" href="#客户端"><span>客户端</span></a></h3><ol><li>通过 redis-cli 连接。</li><li>其它第三方客户端如 jedis 等。</li><li>可视化 GUI 推荐 <a href="https://gitee.com/qishibo/AnotherRedisDesktopManager/releases" target="_blank" rel="noopener noreferrer">AnotherRedisDesktopManager</a>，主要是好看。还有 rdm 或者 medis 可以选择，实在都不喜欢可以去 <a href="https://github.com/" target="_blank" rel="noopener noreferrer">github</a> 找一下喜欢的。</li></ol><h2 id="持久化方案" tabindex="-1"><a class="header-anchor" href="#持久化方案"><span>持久化方案</span></a></h2><h3 id="rdb-redis-database" tabindex="-1"><a class="header-anchor" href="#rdb-redis-database"><span>RDB（Redis Database）</span></a></h3><p>每间隔一段时间生成一个快照。该时间段可配置。快照生成后会覆盖之前的快照，所以只有一个快照文件，生成的过程中会有一个临时文件。这种持久化方案是 Redis 默认的方案。优点是恢复快，缺点是可能损失的数据会大。</p><p>手动使用主进程执行 RDB 备份的命令<code>save</code>。该命令会阻塞。</p><p>手动开启其它进程执行 RDB 备份的命令<code>bgsave</code>。该命令不会阻塞。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">save</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">OK</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">bgsave</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Background</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> saving</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> started</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可配置 rdb 文件的位置和名字。默认是在执行开启 redis-server 的当前目录，文件名是<code>dump.rdb</code>。建议将<code>dir</code>写死成固定目录。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">dir</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ./</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">dbfilename</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> dump.rdb</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>定时生成 RDB 文件的时间可以配置。如下配置表示三个条件，满足其一就执行一次备份。如果关闭 RDB 功能，则无需配置该选项。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 900s 内有1次数据更改</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">save</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 900</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 300s 内有10次数据更改</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">save</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 300</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 10</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 60s 内有10000次数据更改</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">save</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 60</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 10000</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="aof-append-only-file" tabindex="-1"><a class="header-anchor" href="#aof-append-only-file"><span>AOF（Append Only File）</span></a></h3><p>系统记录每一个进程插入或修改的日志，文件会一直增加。优点是恢复慢，由于是同步新增日志，所以损失可以忽略不计。</p><p>开启 AOF 只需配置<code>appendonly yes</code>，此时在之前配置的<code>dir</code>目录下回出现一个<code>appendonly.aof</code>文件。</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">appendonly yes</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">appendfilename </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">appendonly.aof</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>触发机制。</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># no：表示等操作系统进行数据缓存同步到磁盘（快，持久化没保证） </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># always：同步持久化，每次发生数据变更时，立即记录到磁盘（慢，安全） </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># everysec：表示每秒同步一次（默认值,很快，但可能会丢失一秒以内的数据）</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">appendfsync everysec</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="混合持久化" tabindex="-1"><a class="header-anchor" href="#混合持久化"><span>混合持久化</span></a></h3><p>混合持久化吸收了 RDB 和 AOF 两种方式的优点。当 AOF 文件达到一定条件时，redis 会开启一个新的子进程来对 AOF 文件进行重写，比如<code>set name jonkee</code>和<code>del name</code>这两条命令的 AOF 记录就可以清除掉。清除掉之后生成的其实是 RDB 格式的文件，然后将该文件写入 AOF 文件中，此时 AOF 文件中就会存在一部分 RDB 格式的和一部分 AOF 格式的，这样恢复的速度能得到很大提高，也能保证数据最少丢失。</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 开启混合持久化</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">aof-use-rdb-preamble yes</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#当AOF文件大小的增长率大于该配置项时自动开启重写。</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">auto-aof-rewrite-percentage 100</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#当AOF文件大小大于该配置项时自动开启重写</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">auto-aof-rewrite-min-size 5gb</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="缓存穿透、击穿、雪崩" tabindex="-1"><a class="header-anchor" href="#缓存穿透、击穿、雪崩"><span>缓存穿透、击穿、雪崩</span></a></h2><h3 id="缓存穿透" tabindex="-1"><a class="header-anchor" href="#缓存穿透"><span>缓存穿透</span></a></h3><p>缓存穿透就是穿过缓存进入数据库。正常来说使用缓存的流程是这样的。</p><ol><li>根据一个 key 从缓存中获取数据。</li><li>获取到数据就返回。没有获取到数据，则从数据库中获取数据。</li><li>获取到数据就将数据放入缓存，然后返回，没有则直接返回。</li></ol><p>如果知道一个肯定不存在的数据的 key，<strong>数据库没有，缓存中也没有</strong>，请求就会访问数据库。如果恶意攻击的话，会导致数据库压力过大。</p><p>解决方案：</p><ol><li>如果一个 key 没有值得话，可以将这个 null 值存到缓存中，设置一个过期时间。</li><li>接口层增加拦截校验，如布隆过滤器。</li></ol><h3 id="缓存击穿" tabindex="-1"><a class="header-anchor" href="#缓存击穿"><span>缓存击穿</span></a></h3><p>缓存击穿是指从一个点击穿缓存，进入数据库。缓存击穿是对热点数据进行高频率访问的时候，该缓存突然过期或一开始没有该缓存，导致所有的请求集中在一点进入了数据库。</p><p>解决方案：</p><ol><li>设置热点数据永远不过期。</li><li>布隆过滤器。</li><li>接口限流与熔断，降级。</li><li>加互斥锁。</li></ol><h3 id="缓存雪崩" tabindex="-1"><a class="header-anchor" href="#缓存雪崩"><span>缓存雪崩</span></a></h3><p>缓存雪崩是指在某个时间段内，缓存集中过期失效。</p><p>解决方案：</p><ol><li>过期时间不要太集中，给范围随机。</li><li>热点数据永不过期。</li><li>保证机器高可用。</li></ol><h2 id="集群模式" tabindex="-1"><a class="header-anchor" href="#集群模式"><span>集群模式</span></a></h2><h3 id="主从复制" tabindex="-1"><a class="header-anchor" href="#主从复制"><span>主从复制</span></a></h3><p>分为一个 master 节点和多个 slave 节点，slave 节点从 master 同步数据。可实现读写分离，由 master 写，从 slave 读。当 mastere 节点故障之后，slave 节点可以接替成为 master 节点提供服务，但是该操作需要人工完成。</p><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>replica &lt;masterip&gt; &lt;masterport&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="主从复制原理" tabindex="-1"><a class="header-anchor" href="#主从复制原理"><span>主从复制原理</span></a></h3><p>当 slave 连接到 master 之后，发送一个 PSYNC 命令到 master，master 此时 fork 出一个子进程执行 bgsave 命令生成 rdb 文件，在生成发送 rdb 文件期间，如果有新的增删改命令执行，master 会创建一个缓冲区记录这些命令，等生成的 rdb 文件发送到 slave 之后，会将缓冲区里的命令同步给 slave 执行。</p><p>全量同步流程如下： <img src="https://qiqiang.oss-cn-hangzhou.aliyuncs.com/muan/redis1.png" alt="redis1"> 主从复制也支持增量同步。如果 slave 在短时间内与 master 断开连接，可以发送带有偏移量的 PSYNC 命令进行增量同步。master 会在其内存中创建一个复制数据用的缓存队列，缓存最近一段时间的数据，maste r和它所有的 slave 都维护了复制的数据下标 offset 和 master 的进程 id，因此，当网络连接断开后，slave 会请求 master 继续进行未完成的复制，从所记录的数据下标开始。如果 master 进程 id 变化了，或者从节点数据下标 offset 太旧，已经不在 master 的缓存队列里了，那么将会进行一次全量数据的复制。 增量同步流程如下： <img src="https://qiqiang.oss-cn-hangzhou.aliyuncs.com/muan/redis2.png" alt="redis2"></p><h3 id="哨兵模式" tabindex="-1"><a class="header-anchor" href="#哨兵模式"><span>哨兵模式</span></a></h3><p>哨兵模式是基于主从复制模式的，在此基础上多了一个哨兵的角色，哨兵可以监控 master 和 slave 的状态，在 master 出现问题时，能够从 slave 中选取一个节点作为新的 master 来保证系统正常工作。</p><p>原理：心跳机制加投票裁决。每个哨兵会定时向其它哨兵、master 和 slave 发送心跳，确保对方还活着，当多数哨兵报告某个 master 已经宕机之后，系统会投票从 slave 中选出新的 master。</p><h3 id="cluster-模式" tabindex="-1"><a class="header-anchor" href="#cluster-模式"><span>cluster 模式</span></a></h3><p>cluster 集群模式本质上是多个主从复制模式的集合，即一个 cluster 集群包括3个以上的主从复制小集群。cluster 集群引入了<strong>哈希槽</strong>的概念，Redis 集群有16384个哈希槽,每个key通过CRC16校验后对16384取模来决定放置哪个槽。集群的每个节点负责一部分hash槽，举个例子,比如当前集群有3个节点，那么:</p><ul><li>节点 A 包含 0 到 5500号哈希槽.</li><li>节点 B 包含5501 到 11000 号哈希槽.</li><li>节点 C 包含11001 到 16384号哈希槽.</li></ul><h4 id="cluster-搭建实战" tabindex="-1"><a class="header-anchor" href="#cluster-搭建实战"><span>cluster 搭建实战</span></a></h4><p>搭建一个 cluster 集群，包括三个 master-slave 集群，即总共需要6个节点。因为在同一台机器上搭建，所以用端口号区分，端口从6000-6005。</p><ol><li><p>创建工作空间。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mkdir</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /redis/cluster</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> &amp;</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /redis/cluster</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mkdir</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 6000</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> &amp;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> cp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/redis/redis.conf</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /redis/cluster/6000/</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>修改配置文件。</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">bind 10.255.0.223</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">port 6000</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">daemonize yes</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">pidfile /redis/cluster/6000/redis_6000.pid</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">logfile </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/redis/cluster/6000/redis.log</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">dir /redis/cluster/6000/</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">cluster-enabled yes</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">cluster-config-file nodes-6000.conf</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">requirepass jonkee</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">masterauth jonkee</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>将其它节点的配置文件做同样的更改。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mkdir</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 6001</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> &amp;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> mkdir</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 6002</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> &amp;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> mkdir</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 6003</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> &amp;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  mkdir</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 6004</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> &amp;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> mkdir</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 6005</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 替换配置文件中的端口号，输出到新的配置文件中</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sed</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">s/6000/6001/g</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 6000/redis.conf</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 6001/redis.conf</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>启动所有 redis，启动之后查看 redis 进程，可以见到一个 <strong>[cluster]</strong> 标记，但是此时的六个节点都是相互独立的。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">/usr/local/bin/redis-server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 6000/redis.conf</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ps</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -ef</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">grep</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> redis</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>redis 进程如下：</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>root       547     1  0 22:26 ?        00:00:00 /usr/local/bin/redis-server 10.255.0.223:6001 [cluster]</span></span>
<span class="line"><span>root       755     1  0 22:26 ?        00:00:00 /usr/local/bin/redis-server 10.255.0.223:6002 [cluster]</span></span>
<span class="line"><span>root       976     1  0 22:26 ?        00:00:00 /usr/local/bin/redis-server 10.255.0.223:6003 [cluster]</span></span>
<span class="line"><span>root      1142     1  0 22:26 ?        00:00:00 /usr/local/bin/redis-server 10.255.0.223:6004 [cluster]</span></span>
<span class="line"><span>root      1399     1  0 22:26 ?        00:00:00 /usr/local/bin/redis-server 10.255.0.223:6005 [cluster]</span></span>
<span class="line"><span>root     30666     1  0 22:25 ?        00:00:00 /usr/local/bin/redis-server 10.255.0.223:6000 [cluster]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>搭建集群及分配哈希槽。搭建过程中会输出主从信息和分配的哈希槽信息，输入 <strong>yes</strong> 确认。可以看到6000、6001和6002是 master 节点，哈希槽位分别是[0-5460]、[5461-10922]和[10923-16383]，它们的 slave 节点是6005、6003和6004。注意，这里集群节点间的通信用的是内网 ip，如果要在外网使用会存在连接不上的问题，解决这个问题可以换成域名通信。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">/usr/local/bin/redis-cli</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --cluster</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> create</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    10.255.0.223:6000</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 10.255.0.223:6001</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 10.255.0.223:6002</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    10.255.0.223:6003</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 10.255.0.223:6004</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 10.255.0.223:6005</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">    --cluster-replicas</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行成功后可以看到如下信息：</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>M: 4418f4dc304c9cdda79b63f7da3d66010080d2ea 10.255.0.223:6000</span></span>
<span class="line"><span>   slots:[0-5460] (5461 slots) master</span></span>
<span class="line"><span>M: da0dfdebf6c40967e907b401852339cc4e396030 10.255.0.223:6001</span></span>
<span class="line"><span>   slots:[5461-10922] (5462 slots) master</span></span>
<span class="line"><span>M: eb5c6796acdf0c5009e46493bac7d748429e552f 10.255.0.223:6002</span></span>
<span class="line"><span>   slots:[10923-16383] (5461 slots) master</span></span>
<span class="line"><span>S: f6d0043ba84adaaa1ee53d60df5c8ee6468fe1e3 10.255.0.223:6003</span></span>
<span class="line"><span>   replicates da0dfdebf6c40967e907b401852339cc4e396030</span></span>
<span class="line"><span>S: cba8160ff71e9185a84466f535b0f517928b2789 10.255.0.223:6004</span></span>
<span class="line"><span>   replicates eb5c6796acdf0c5009e46493bac7d748429e552f</span></span>
<span class="line"><span>S: 2658465eac3c8bbd899816c6ac786e140bc4533e 10.255.0.223:6005</span></span>
<span class="line"><span>   replicates 4418f4dc304c9cdda79b63f7da3d66010080d2ea</span></span>
<span class="line"><span>Can I set the above configuration? (type &#39;yes&#39; to accept): yes</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>查看集群状态。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">/usr/local/bin/redis-cli</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -h</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 10.255.0.223</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 6002</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -a</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> jonkee</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cluster</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nodes</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>结果如下：</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>2658465eac3c8bbd899816c6ac786e140bc4533e 10.255.0.223:6005@16005 slave 4418f4dc304c9cdda79b63f7da3d66010080d2ea 0 1587566606616 6 connected</span></span>
<span class="line"><span>cba8160ff71e9185a84466f535b0f517928b2789 10.255.0.223:6004@16004 slave eb5c6796acdf0c5009e46493bac7d748429e552f 0 1587566601000 5 connected</span></span>
<span class="line"><span>eb5c6796acdf0c5009e46493bac7d748429e552f 10.255.0.223:6002@16002 myself,master - 0 1587566604000 3 connected 10923-16383</span></span>
<span class="line"><span>da0dfdebf6c40967e907b401852339cc4e396030 10.255.0.223:6001@16001 master - 0 1587566605000 2 connected 5461-10922</span></span>
<span class="line"><span>f6d0043ba84adaaa1ee53d60df5c8ee6468fe1e3 10.255.0.223:6003@16003 slave da0dfdebf6c40967e907b401852339cc4e396030 0 1587566603000 4 connected</span></span>
<span class="line"><span>4418f4dc304c9cdda79b63f7da3d66010080d2ea 10.255.0.223:6000@16000 master - 0 1587566604611 1 connected 0-5460</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>连接测试，任意连接一个节点即可，注意要加上 -c 表示以集群模式连接。当存入<code>key1</code>时，计算出的哈希槽是 9189，落在 6001 节点上。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/local/bin/redis-cli</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -c</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -h</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 10.255.0.223</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 6000</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -a</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> jonkee</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>验证一把</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>10.255.0.223:6000&gt; set key1 value1</span></span>
<span class="line"><span>-&gt; Redirected to slot [9189] located at 10.255.0.223:6001</span></span>
<span class="line"><span>OK</span></span>
<span class="line"><span>10.255.0.223:6001&gt; cluster keyslot key1</span></span>
<span class="line"><span>(integer) 9189</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h2 id="删除策略和淘汰策略" tabindex="-1"><a class="header-anchor" href="#删除策略和淘汰策略"><span>删除策略和淘汰策略</span></a></h2><h3 id="删除策略" tabindex="-1"><a class="header-anchor" href="#删除策略"><span>删除策略</span></a></h3><p>Redis 删除策略指 Key 如果有过期时间，将会根据一些策略来对这些 key 进行删除。</p><ol><li><p>惰性删除</p><p>当写入或读取到某个过期的 key 时，发现该 key 过期了，则删除。</p></li><li><p>定期删除</p><p>惰性过期无法删掉冷数据（长时间没有被读取，所以无法删除），此时要定期删除已经过期的 key。</p></li><li><p>定时删除</p><p>redis 在设置 key 的过期时间的时候回创建一个定时器，当过期时间到达时会触发该定时器来删除 key。这种做法是以 cpu 来节省内存。</p></li></ol><h3 id="淘汰策略" tabindex="-1"><a class="header-anchor" href="#淘汰策略"><span>淘汰策略</span></a></h3><p>当内存超过设置的 maxMemory 时，则触发淘汰策略。</p><p>缓存淘汰算法有以下几种：</p><ul><li>volatile-lru：从已经设置过期时间的数据中选出<strong>最近最少</strong>使用的数据淘汰。</li><li>volatile-ttl：从已经设置过期时间的数据中选出<strong>将要过期</strong>的数据淘汰。</li><li>volatile-random：从已经设置过期时间的额数据中<strong>随机选出任意数据</strong>淘汰。</li><li>volatile-lfu：从已设置过期时间的数据集挑选使用<strong>频率最低</strong>的数据淘汰。</li><li>allkeys-lru：从所有数据中选出<strong>最近最少</strong>使用的数据淘汰。</li><li>allkeys-lfu：从数据集中挑选使用<strong>频率最低</strong>的数据淘汰。</li><li>allkeys-random：从所有数据中<strong>随机选出任意数据</strong>淘汰。</li><li>no-enviction：<strong>禁止</strong>驱逐数据。</li></ul><h2 id="事务" tabindex="-1"><a class="header-anchor" href="#事务"><span>事务</span></a></h2><p>事务操作演示。<code>MULTI</code>开启事务，<code>EXEC</code>提交事务，<code>DISCARD</code>回滚事务。</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>10.255.0.223:6379&gt; MULTI </span></span>
<span class="line"><span>OK</span></span>
<span class="line"><span>10.255.0.223:6379&gt; set k1 v1</span></span>
<span class="line"><span>QUEUED</span></span>
<span class="line"><span>10.255.0.223:6379&gt; set k2 v2</span></span>
<span class="line"><span>QUEUED</span></span>
<span class="line"><span>10.255.0.223:6379&gt; EXEC</span></span>
<span class="line"><span>1) OK</span></span>
<span class="line"><span>2) OK</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意，如果中途出现异常，那么事务会自动回滚。如果中途没有异常而是在提交后异常，那么只有出现异常的命令会无效，其它命令依然有效。</p><h2 id="场景实战" tabindex="-1"><a class="header-anchor" href="#场景实战"><span>场景实战</span></a></h2><h3 id="如何存储一个用户的信息" tabindex="-1"><a class="header-anchor" href="#如何存储一个用户的信息"><span>如何存储一个用户的信息</span></a></h3><p>一个用户的信息有很多字段，如：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> class</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> User</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    int</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    String</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    boolean</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> sex</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    int</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> age</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此时可以用<strong>hash</strong>这种数据结构，也可以用<strong>string</strong>的<strong>mset</strong>和<strong>mget</strong>命令，如：</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>redis&gt; mset user:1:name jonkee user:1:sex true user:1:age 26</span></span>
<span class="line"><span>OK</span></span>
<span class="line"><span>redis&gt; mget user:1:name user:1:sex user:1:age</span></span>
<span class="line"><span>0 jonkee</span></span>
<span class="line"><span>1 true</span></span>
<span class="line"><span>2 26</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="如何实现浏览量" tabindex="-1"><a class="header-anchor" href="#如何实现浏览量"><span>如何实现浏览量</span></a></h3><p>可以使用<strong>incr</strong>原子命令对一个key的值进行加一。如果该 key 不存在则会初始为0，然后再进行加一。对应的减一操作是<strong>decr</strong></p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">incr</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> article:view:1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">incr</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> article:view:1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">2</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">incr</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> article:view:1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">3</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="分布式-id-如何生成" tabindex="-1"><a class="header-anchor" href="#分布式-id-如何生成"><span>分布式 id 如何生成</span></a></h3><p>可以使用<strong>incrby</strong>命令生成id。每一台机器实例来 redis 中通过<strong>incrby userid 1000</strong>来获取id，就是说每次获取到1000个id，第二台机器来获取的时候就是从1000之后再获取1000个id，借助于 redis 的单线程特性生成分布式 id。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">incrby</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> userid</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1000</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1000</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">incrby</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> userid</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1000</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">2000</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="设计一个购物车" tabindex="-1"><a class="header-anchor" href="#设计一个购物车"><span>设计一个购物车</span></a></h3><p>一个用户有个购物车，一般有如下操作。</p><ul><li>添加商品。<code>hset cart:{userid} {goodsid} 1</code></li><li>商品加1。<code>hincrby cart:{userid} {goodsid} 1</code></li><li>获取商品的总数。<code>hlen cart:{userid}</code></li><li>获取所有的商品。<code>hgetall cart:{userid}</code></li><li>删除商品。<code>hdel cart:{userid} {goodsid}</code></li></ul><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">hset</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cart:1</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1001</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">hset</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cart:1</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1002</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">hincrby</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cart:1</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1001</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">2</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">hlen</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cart:1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">2</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">hgetall</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cart:1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1001</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1002</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">hdel</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cart:1</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1001</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">hgetall</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cart:1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1002</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="设计微信公众号推送信息列表" tabindex="-1"><a class="header-anchor" href="#设计微信公众号推送信息列表"><span>设计微信公众号推送信息列表</span></a></h3><p>当某个公众号发了一条推送之后，会向所有订阅这个公众号的用户推送这条消息。将用户要接收的信息放到一个<strong>list</strong>中可以轻松实现该功能。</p><ul><li>将消息放入订阅列表。<code>lpush submsg:{userid} {msgid}</code></li><li>获取最新消息。<code>lrange submsg{userid} {start} {stop}</code></li></ul><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">lpush</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> submsg:1</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 100</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">lpush</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> submsg:1</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 101</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">2</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">lpush</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> submsg:1</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 102</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">3</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">lrange</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> submsg:1</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">0</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 102</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 101</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="设计抽奖活动" tabindex="-1"><a class="header-anchor" href="#设计抽奖活动"><span>设计抽奖活动</span></a></h3><p>一个抽奖活动有一下几个步骤。</p><ol><li>参与抽奖。<code>sadd activity:{id} {userid}</code></li><li>查看所有用户。<code>smembers activity:{id}</code></li><li>抽奖，两个名额。<code>srandmenbers activity:{id} 2</code>或者<code>spop activity:{id} 1</code></li></ol><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">sadd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> activity:1</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 100</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">sadd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> activity:1</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 101</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">sadd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> activity:1</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 102</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">smembers</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> activity:1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">0</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 100</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 101</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">2</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 102</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">srandmember</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> activity:1</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">0</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 101</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 100</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="点赞功能" tabindex="-1"><a class="header-anchor" href="#点赞功能"><span>点赞功能</span></a></h3><p>点赞功能一般有如下操作。</p><ol><li>点赞。<code>sadd like:{msgid} {userid}</code></li><li>是否已经点过赞。<code>sismember like:{msgid} {userid}</code></li><li>所有点赞的人。<code>smember</code></li><li>取消点赞。<code>srem like:{msgid} {userid}</code></li></ol><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">sadd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> like:1</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 100</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">sadd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> like:1</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 101</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">sismember</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> like:1</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 100</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">sismember</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> like:1</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 104</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">0</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">smembers</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> like:1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">0</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 100</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 101</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">srem</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> like:1</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 100</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">smembers</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> like:1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">0</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 101</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="关注模型-认识的人功能" tabindex="-1"><a class="header-anchor" href="#关注模型-认识的人功能"><span>关注模型/认识的人功能</span></a></h3><ol><li>A 关注了【B，C，D】</li><li>B 关注了【A，C，D，E】</li><li>C 关注了【B，E，F】</li><li>计算 A 和 B 共同关注的人（交集）。<code>sinter follow:A follow:B</code></li><li>计算 A 关注的人是否也关注了 B，排除 B 自身，对其它人做<code>sismember</code>操作。</li><li>计算 A 可能认识的人。因为 A 和 B 相互关注，B 关注的人 A 没有关注，但是 A 可能认识这些人。<code>sdiff follow:B follow:A</code></li></ol><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">sadd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> follow:A</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> B</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> C</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> D</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">3</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">sadd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> follow:B</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> A</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> C</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> D</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> E</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">4</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">sadd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> follow:C</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> B</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> E</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> F</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">3</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">sinter</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> follow:A</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> follow:B</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">0</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> D</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> C</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">sismember</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> follow:C</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> B</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">sismember</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> follow:D</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> B</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">0</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">sdiff</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> follow:B</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> follow:A</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">0</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> A</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> E</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="其它问题" tabindex="-1"><a class="header-anchor" href="#其它问题"><span>其它问题</span></a></h2><ol><li><p>为什么网络模块采用单线程？</p><p>因为 Cpu 不是 Redis 的瓶颈，影响 Redis 性能的是内存和网络带宽，所以没有上下文切换的单线程能很容易实现。</p></li><li><p>哨兵模式需要注意什么？</p><p>至少需要三个哨兵，须奇数个。</p></li><li><p>如何用 Redis 实现分布式锁？需要注意什么？</p><ol><li><p>加锁的必须使用 set(key,value,nx,ex)，即如果 key 不存在，则加锁成功，否则加锁失败。要为 key 设置过期时间，避免由于网络问题或其它原因导致客户端没有成功释放锁导致其它客户端永远无法访问。</p></li><li><p>释放锁需要获取锁，然后判断该锁是不是当前客户端持有的锁，然后删除，三个动作必须是原子操作，所以要用 lua 脚本来写，脚本如下：</p></li></ol><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="Copy code" data-copied="Copied"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>if redis.call(&#39;get&#39;, KEYS[1]) == ARGV[1] then return redis.call(&#39;del&#39;, KEYS[1]) else return 0 end</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>RDB 和 AOF 两种持久化方案共存时，数据以哪种方式为准？会存在数据丢失的问题吗？怎么解决？</p><p>RDB 和 AOP 同时开启时，会以 AOF 为准，如果 RDB 的文件比较新，那么 RDB 的数据会丢失。解决该问题可以在配置文件中先关闭 AOF，以 RDB 的方式启动，等加载完成之后用客户端执行<code>config set appendonly yes</code>命令，这样可以生成最新的<code>appendonly.aof</code>文件，然后下次就可以在配置文件中开启 AOP 了。</p></li><li><p>redis 为什么快?</p><ol><li>完全基于内存。要么是数据在内存，要么是数据在硬盘，索引在内存。</li><li>数据结构简单。</li><li>网络模块单线程，减少了不必要的上下文切换和竞争，不用考虑各种锁的性能消耗。</li><li>使用多路复用 IO 模型，非阻塞 IO。</li></ol></li><li><p>cluster 集群扩容与缩容操作过程。</p></li></ol><h2 id="附录" tabindex="-1"><a class="header-anchor" href="#附录"><span>附录</span></a></h2><ol><li><a href="http://www.redis.cn/" target="_blank" rel="noopener noreferrer">redis 中文网</a>。</li><li>可视化 GUI 推荐 <a href="https://gitee.com/qishibo/AnotherRedisDesktopManager/releases" target="_blank" rel="noopener noreferrer">AnotherRedisDesktopManager</a>。</li><li>超好用的 java redis 框架 <a href="https://github.com/redisson/redisson/wiki/%E7%9B%AE%E5%BD%95" target="_blank" rel="noopener noreferrer">redision</a>。</li></ol>`,105)]))}const h=i(l,[["render",t],["__file","index.html.vue"]]),r=JSON.parse('{"path":"/middleware/redis/ba9ae9/","title":"一篇文章搞懂 Redis 从面试到应用","lang":"en-US","frontmatter":{"title":"一篇文章搞懂 Redis 从面试到应用","createTime":"2022-06-05T10:16:44.000Z","permalink":"/middleware/redis/ba9ae9/"},"headers":[],"readingTime":{"minutes":15.87,"words":4761},"git":{"updatedTime":1732511545000,"contributors":[{"name":"qiqiang","email":"qiqiang@pingpongx.com","commits":3,"avatar":"https://avatars.githubusercontent.com/qiqiang?v=4","url":"https://github.com/qiqiang"},{"name":"qiqiang","email":"qiqiang","commits":5,"avatar":"https://avatars.githubusercontent.com/qiqiang?v=4","url":"https://github.com/qiqiang"}]},"filePathRelative":"notes/middleware/redis/10.一篇文章搞懂Redis从面试到应用.md","bulletin":false}');export{h as comp,r as data};
