# é›¶æ‹·è´è¯¦è§£ï¼šä»å°ç™½åˆ°ç²¾é€š

## ä¸€ã€ä»€ä¹ˆæ˜¯é›¶æ‹·è´ï¼Ÿ

æƒ³è±¡ä¸€ä¸‹è¿™ä¸ªåœºæ™¯ï¼šä½ åœ¨é¤å…ç‚¹äº†ä¸€ä»½å¤–å–æŠ«è¨ã€‚

**ä¼ ç»Ÿæ–¹å¼ï¼ˆå¤šæ¬¡å€’æ‰‹ï¼‰**ï¼š

1. å¨å¸ˆåšå¥½æŠ«è¨æ”¾åœ¨å¨æˆ¿å°å­ä¸Š ğŸ•
2. æœåŠ¡å‘˜Aä»å¨æˆ¿æ‹¿åˆ°å‰å°
3. æœåŠ¡å‘˜Bä»å‰å°æ‹¿åˆ°æ‰“åŒ…åŒº
4. æœåŠ¡å‘˜Cä»æ‰“åŒ…åŒºæ‹¿ç»™å¤–å–å‘˜
5. å¤–å–å‘˜æ‰èƒ½é€ç»™ä½ 

**é›¶æ‹·è´æ–¹å¼ï¼ˆç›´è¾¾ï¼‰**ï¼š

- å¨å¸ˆåšå¥½æŠ«è¨ â†’ ç›´æ¥é€’ç»™å¤–å–å‘˜ â†’ é€åˆ°ä½ æ‰‹ä¸Š ğŸš€

**æ ¸å¿ƒæ€æƒ³**ï¼šæŠ«è¨è¿˜æ˜¯é‚£ä¸ªæŠ«è¨ï¼Œä½†å‡å°‘äº†ä¸­é—´å€’æ‰‹çš„æ¬¡æ•°ï¼

é›¶æ‹·è´å°±æ˜¯**å‡å°‘æ•°æ®åœ¨å†…å­˜ä¸­ä¸å¿…è¦çš„æ¬è¿æ¬¡æ•°**ï¼Œè®©æ•°æ®ä¼ è¾“æ›´é«˜æ•ˆã€‚

---

## äºŒã€ä¼ ç»Ÿæ•°æ®ä¼ è¾“ï¼ˆ4æ¬¡æ‹·è´ï¼‰

### åœºæ™¯ï¼šä»ç£ç›˜è¯»å–æ–‡ä»¶ï¼Œé€šè¿‡ç½‘ç»œå‘é€å‡ºå»

```mermaid
graph TB
    A[ç£ç›˜æ–‡ä»¶ ğŸ’¾] -->|â‘ DMAæ‹·è´| B[å†…æ ¸ç¼“å†²åŒº<br/>Kernel Buffer]
    B -->|â‘¡CPUæ‹·è´<br/>éœ€è¦CPUå¹²æ´»| C[åº”ç”¨ç¨‹åºç¼“å†²åŒº<br/>User Buffer]
    C -->|â‘¢CPUæ‹·è´<br/>éœ€è¦CPUå¹²æ´»| D[Socketç¼“å†²åŒº<br/>Kernel Buffer]
    D -->|â‘£DMAæ‹·è´| E[ç½‘å¡ ğŸ“¡]
  
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#ffe1e1
    style D fill:#fff4e1
    style E fill:#e1ffe1
  
    classDef cpuCopy fill:#ffcccc
    classDef dmaCopy fill:#ccffcc
```

### è¯¦ç»†æ­¥éª¤è¯´æ˜ï¼š

```mermaid
sequenceDiagram
    participant D as ç£ç›˜ğŸ’¾
    participant KB as å†…æ ¸ç¼“å†²åŒº
    participant UB as ç”¨æˆ·ç¼“å†²åŒº
    participant SB as Socketç¼“å†²åŒº
    participant N as ç½‘å¡ğŸ“¡
  
    Note over D,N: ä¼ ç»Ÿæ–¹å¼ï¼š4æ¬¡æ‹·è´ + 4æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢
  
    D->>KB: â‘ DMAæ‹·è´ï¼ˆç¡¬ä»¶æ“ä½œï¼‰
    Note over KB: ç”¨æˆ·æ€â†’å†…æ ¸æ€åˆ‡æ¢
    KB->>UB: â‘¡CPUæ‹·è´ï¼ˆæµªè´¹CPUï¼‰
    Note over UB: å†…æ ¸æ€â†’ç”¨æˆ·æ€åˆ‡æ¢
    UB->>SB: â‘¢CPUæ‹·è´ï¼ˆæµªè´¹CPUï¼‰
    Note over SB: ç”¨æˆ·æ€â†’å†…æ ¸æ€åˆ‡æ¢
    SB->>N: â‘£DMAæ‹·è´ï¼ˆç¡¬ä»¶æ“ä½œï¼‰
    Note over N: å†…æ ¸æ€â†’ç”¨æˆ·æ€åˆ‡æ¢
```

### Javaä»£ç ç¤ºä¾‹ï¼š

```java
// ä¼ ç»ŸIOï¼šæŠ«è¨è¢«å€’æ‰‹4æ¬¡ï¼
File file = new File("data.txt");
FileInputStream in = new FileInputStream(file);
byte[] buffer = new byte[4096];

// æ­¥éª¤â‘ â‘¡ï¼šä»ç£ç›˜è¯»åˆ°ç”¨æˆ·ç©ºé—´
int len = in.read(buffer);  

// æ­¥éª¤â‘¢â‘£ï¼šä»ç”¨æˆ·ç©ºé—´å†™åˆ°ç½‘å¡
socket.getOutputStream().write(buffer, 0, len);
```

**é—®é¢˜åˆ†æ**ï¼š

| æ­¥éª¤ | ä»å“ªé‡Œ       | åˆ°å“ªé‡Œ       | æ‹·è´æ–¹å¼ | æ¯”å–»              |
| ---- | ------------ | ------------ | -------- | ----------------- |
| â‘    | ç£ç›˜         | å†…æ ¸ç¼“å†²åŒº   | DMAæ‹·è´  | å¨å¸ˆåšå¥½æŠ«è¨      |
| â‘¡   | å†…æ ¸ç¼“å†²åŒº   | ç”¨æˆ·ç¼“å†²åŒº   | CPUæ‹·è´  | æœåŠ¡å‘˜Aæ‹¿åˆ°å‰å°   |
| â‘¢   | ç”¨æˆ·ç¼“å†²åŒº   | Socketç¼“å†²åŒº | CPUæ‹·è´  | æœåŠ¡å‘˜Bæ‹¿åˆ°æ‰“åŒ…åŒº |
| â‘£   | Socketç¼“å†²åŒº | ç½‘å¡         | DMAæ‹·è´  | å¤–å–å‘˜é€å‡ºå»      |

---

## ä¸‰ã€æ“ä½œç³»ç»Ÿé›¶æ‹·è´æŠ€æœ¯

### æ–¹æ¡ˆ1ï¼šmmapï¼ˆå†…å­˜æ˜ å°„ï¼‰- 3æ¬¡æ‹·è´

```mermaid
graph TB
    A[ç£ç›˜æ–‡ä»¶ ğŸ’¾] -->|â‘ DMAæ‹·è´| B[å†…æ ¸ç¼“å†²åŒº]
    B -.->|å…±äº«å†…å­˜æ˜ å°„<br/>ä¸éœ€è¦æ‹·è´| C[ç”¨æˆ·ç©ºé—´<br/>æ˜ å°„åŒºåŸŸ]
    B -->|â‘¡CPUæ‹·è´| D[Socketç¼“å†²åŒº]
    D -->|â‘¢DMAæ‹·è´| E[ç½‘å¡ ğŸ“¡]
  
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#e1ffe1
    style D fill:#fff4e1
    style E fill:#e1ffe1
  
    linkStyle 1 stroke:#00ff00,stroke-width:3px,stroke-dasharray: 5
```

**æ¯”å–»**ï¼šå¨æˆ¿å’Œå‰å°æ‰“é€šäº†ï¼ŒæœåŠ¡å‘˜ä¸ç”¨æ¬æŠ«è¨ï¼Œç›´æ¥åœ¨çª—å£å°±èƒ½çœ‹åˆ°å’Œæ“ä½œï¼

```java
// Java NIOçš„mmap
FileChannel fileChannel = new FileInputStream("data.txt").getChannel();
MappedByteBuffer mappedBuffer = fileChannel.map(
    FileChannel.MapMode.READ_ONLY, 0, fileChannel.size()
);
socketChannel.write(mappedBuffer);  // å‡å°‘1æ¬¡æ‹·è´
```

---

### æ–¹æ¡ˆ2ï¼šsendfileï¼ˆçœŸæ­£çš„é›¶æ‹·è´ï¼‰- 2æ¬¡æ‹·è´

```mermaid
graph TB
    A[ç£ç›˜æ–‡ä»¶ ğŸ’¾] -->|â‘ DMAæ‹·è´| B[å†…æ ¸ç¼“å†²åŒº]
    B -->|â‘¡ç›´æ¥ä¼ è¾“<br/>å†…æ ¸ç©ºé—´å†…éƒ¨| C[Socketç¼“å†²åŒº]
    C -->|â‘¢DMAæ‹·è´| D[ç½‘å¡ ğŸ“¡]
  
    E[ç”¨æˆ·ç©ºé—´] -.->|å®Œå…¨ä¸ç»è¿‡<br/>ç”¨æˆ·ç©ºé—´| E
  
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#fff4e1
    style D fill:#e1ffe1
    style E fill:#f0f0f0,stroke-dasharray: 5
```

**æ¯”å–»**ï¼šå¨å¸ˆåšå¥½æŠ«è¨ï¼Œç›´æ¥ä»å¨æˆ¿çª—å£é€’ç»™å¤–å–å‘˜ï¼Œä¸­é—´æœåŠ¡å‘˜å…¨éƒ¨çœç•¥ï¼

```mermaid
sequenceDiagram
    participant D as ç£ç›˜ğŸ’¾
    participant KB as å†…æ ¸ç¼“å†²åŒº
    participant SB as Socketç¼“å†²åŒº
    participant N as ç½‘å¡ğŸ“¡
  
    Note over D,N: sendfileï¼šåªæœ‰2æ¬¡DMAæ‹·è´
  
    D->>KB: â‘ DMAæ‹·è´
    Note over KB,SB: æ•°æ®åœ¨å†…æ ¸ç©ºé—´å†…éƒ¨ä¼ è¾“<br/>ä¸ç»è¿‡ç”¨æˆ·ç©ºé—´
    KB->>SB: â‘¡å†…æ ¸å†…éƒ¨ä¼ è¾“
    SB->>N: â‘¢DMAæ‹·è´
  
    Note over D,N: CPUå‡ ä¹ä¸å‚ä¸ï¼Œæ€§èƒ½æœ€ä¼˜ï¼
```

```java
// Java NIOçš„é›¶æ‹·è´ï¼šæœ€ä¼˜æ–¹æ¡ˆ
FileChannel sourceChannel = new FileInputStream("data.txt").getChannel();
SocketChannel socketChannel = SocketChannel.open();

// åº•å±‚ä½¿ç”¨sendfileç³»ç»Ÿè°ƒç”¨
sourceChannel.transferTo(0, sourceChannel.size(), socketChannel);
```

---

### æ–¹æ¡ˆ3ï¼šspliceï¼ˆLinuxç®¡é“ï¼‰

```mermaid
graph LR
    A[æ–‡ä»¶æè¿°ç¬¦] -->|spliceç³»ç»Ÿè°ƒç”¨| B[å†…æ ¸ç®¡é“<br/>Pipe Buffer]
    B --> C[Socketæè¿°ç¬¦]
  
    style A fill:#e1f5ff
    style B fill:#ffe1e1
    style C fill:#e1ffe1
```

---

## å››ã€Nettyçš„é›¶æ‹·è´ï¼ˆåº”ç”¨å±‚ä¼˜åŒ–ï¼‰

Nettyçš„é›¶æ‹·è´æ˜¯**æ›´å¹¿ä¹‰çš„æ¦‚å¿µ**ï¼ŒåŒ…å«å¤šä¸ªå±‚é¢çš„ä¼˜åŒ–ã€‚

### 1ï¸âƒ£ Direct Bufferï¼ˆç›´æ¥å†…å­˜ï¼‰

```mermaid
graph TB
    subgraph ä¼ ç»ŸHeapBuffer
    A1[JVMå †å†…å­˜] -->|éœ€è¦æ‹·è´| B1[å†…æ ¸ç¼“å†²åŒº] --> C1[ç½‘å¡]
    end
  
    subgraph Netty DirectBuffer
    A2[å †å¤–ç›´æ¥å†…å­˜] -.->|é›¶æ‹·è´<br/>ç›´æ¥è®¿é—®| C2[ç½‘å¡]
    end
  
    style A1 fill:#ffe1e1
    style B1 fill:#fff4e1
    style A2 fill:#e1ffe1
    style C2 fill:#e1ffe1
```

**æ¯”å–»**ï¼š

- **HeapBuffer**ï¼šæŠ«è¨æ”¾åœ¨åº—é‡Œçš„ç›’å­ï¼Œå¤–å–å‘˜æ¥äº†è¿˜è¦æ¢æˆå¤–å–ç›’
- **DirectBuffer**ï¼šæŠ«è¨ç›´æ¥æ”¾åœ¨å¤–å–ç›’é‡Œï¼Œå¤–å–å‘˜ç›´æ¥æ‹¿èµ°

```java
// Nettyä½¿ç”¨ç›´æ¥å†…å­˜
ByteBuf directBuf = Unpooled.directBuffer(256);
directBuf.writeBytes("Hello Netty".getBytes());
channel.writeAndFlush(directBuf);  // æ— éœ€æ‹·è´åˆ°å†…æ ¸
```

---

### 2ï¸âƒ£ CompositeByteBufï¼ˆç»„åˆç¼“å†²åŒºï¼‰

```mermaid
graph TB
    subgraph ä¼ ç»Ÿæ–¹å¼
    A1[Buffer1: Header] --> C1[æ–°Buffer]
    B1[Buffer2: Body] --> C1
    C1 --> D1[éœ€è¦æ‹·è´æ•°æ®]
    end
  
    subgraph Nettyæ–¹å¼
    A2[Buffer1: Header] -.-> C2[CompositeByteBuf<br/>é€»è¾‘è§†å›¾]
    B2[Buffer2: Body] -.-> C2
    C2 --> D2[åªä¿å­˜å¼•ç”¨<br/>é›¶æ‹·è´]
    end
  
    style C1 fill:#ffe1e1
    style D1 fill:#ffe1e1
    style C2 fill:#e1ffe1
    style D2 fill:#e1ffe1
  
    linkStyle 2,3 stroke:#00ff00,stroke-width:2px,stroke-dasharray: 5
```

**æ¯”å–»**ï¼š

- **ä¼ ç»Ÿæ–¹å¼**ï¼šæŠŠä¸¤ä¸ªæŠ«è¨é‡æ–°è£…åˆ°ä¸€ä¸ªå¤§ç›’å­é‡Œï¼ˆéœ€è¦æ¬è¿ï¼‰
- **Nettyæ–¹å¼**ï¼šç”¨ä¸€æ ¹ç»³å­æŠŠä¸¤ä¸ªæŠ«è¨ç›’ç»‘åœ¨ä¸€èµ·ï¼ˆä¸éœ€è¦æ¬è¿ï¼‰

```java
// Nettyç»„åˆç¼“å†²åŒº
CompositeByteBuf composite = Unpooled.compositeBuffer();
ByteBuf header = Unpooled.buffer(10);
ByteBuf body = Unpooled.buffer(100);

// é›¶æ‹·è´ç»„åˆï¼šåªæ˜¯é€»è¾‘ä¸Šç»„åˆï¼Œä¸æ‹·è´æ•°æ®
composite.addComponents(true, header, body);
```

---

### 3ï¸âƒ£ Sliceï¼ˆåˆ‡ç‰‡ï¼‰

```mermaid
graph TB
    A[åŸå§‹Buffer:<br/>Hello World] --> B[sliceåˆ‡ç‰‡:<br/>World]
  
    A -.->|å…±äº«åº•å±‚æ•°æ®<br/>ä¸æ‹·è´| B
  
    style A fill:#e1f5ff
    style B fill:#e1ffe1
  
    linkStyle 1 stroke:#00ff00,stroke-width:3px,stroke-dasharray: 5
```

**æ¯”å–»**ï¼š

- **ä¼ ç»Ÿæ–¹å¼**ï¼šä»å¤§æŠ«è¨ä¸Šåˆ‡ä¸€å—ï¼Œæ”¾åˆ°æ–°ç›˜å­é‡Œï¼ˆæ‹·è´ï¼‰
- **Sliceæ–¹å¼**ï¼šç›´æ¥åœ¨å¤§æŠ«è¨ä¸Šæ ‡è®°"è¿™å—æ˜¯ä½ çš„"ï¼ˆå…±äº«ï¼‰

```java
ByteBuf buffer = Unpooled.copiedBuffer("Hello World", CharsetUtil.UTF_8);

// sliceåªæ˜¯åˆ›å»ºè§†å›¾ï¼Œå…±äº«åº•å±‚æ•°æ®
ByteBuf slice = buffer.slice(6, 5);  // "World"

System.out.println(slice.toString(CharsetUtil.UTF_8));  // è¾“å‡º: World
// sliceå’Œbufferå…±äº«æ•°æ®ï¼Œä¿®æ”¹ä¸€ä¸ªä¼šå½±å“å¦ä¸€ä¸ª
```

---

### 4ï¸âƒ£ FileRegionï¼ˆæ–‡ä»¶ä¼ è¾“ï¼‰

```mermaid
sequenceDiagram
    participant F as æ–‡ä»¶
    participant FC as FileChannel
    participant FR as FileRegion
    participant N as Netty Channel
    participant OS as æ“ä½œç³»ç»Ÿsendfile
    participant Net as ç½‘å¡
  
    F->>FC: æ‰“å¼€æ–‡ä»¶
    FC->>FR: åˆ›å»ºFileRegion
    FR->>N: writeAndFlush
    N->>OS: è°ƒç”¨sendfile
    OS->>Net: é›¶æ‹·è´ä¼ è¾“
  
    Note over OS,Net: ä½¿ç”¨æ“ä½œç³»ç»Ÿçš„sendfile<br/>æ•°æ®ä¸ç»è¿‡ç”¨æˆ·ç©ºé—´
```

```java
// Nettyé›¶æ‹·è´ä¼ è¾“å¤§æ–‡ä»¶
FileChannel fileChannel = new FileInputStream("movie.mp4").getChannel();
DefaultFileRegion fileRegion = new DefaultFileRegion(
    fileChannel, 0, fileChannel.size()
);

// åº•å±‚ä½¿ç”¨sendfileï¼Œé›¶æ‹·è´ä¼ è¾“
channel.writeAndFlush(fileRegion);
```

---

## äº”ã€æ€§èƒ½å¯¹æ¯”å¯è§†åŒ–

```mermaid
gantt
    title ä¼ è¾“1GBæ–‡ä»¶çš„æ€§èƒ½å¯¹æ¯”
    dateFormat X
    axisFormat %sç§’
  
    section ä¼ ç»ŸIO
    4æ¬¡æ‹·è´+4æ¬¡åˆ‡æ¢ :0, 10
  
    section mmap
    3æ¬¡æ‹·è´+4æ¬¡åˆ‡æ¢ :0, 6
  
    section sendfile
    2æ¬¡æ‹·è´+2æ¬¡åˆ‡æ¢ :0, 3
  
    section Nettyé›¶æ‹·è´
    sendfile+åº”ç”¨ä¼˜åŒ– :0, 2
```

**æ€§èƒ½æå‡**ï¼š

```mermaid
pie title å„æ–¹æ¡ˆCPUå ç”¨ç‡å¯¹æ¯”
    "ä¼ ç»ŸIO" : 80
    "mmap" : 50
    "sendfile" : 20
    "Nettyé›¶æ‹·è´" : 15
```

---

## å…­ã€å®Œæ•´æµç¨‹å¯¹æ¯”

```mermaid
flowchart TD
    Start[å¼€å§‹ä¼ è¾“æ–‡ä»¶]
  
    subgraph ä¼ ç»ŸIOæµç¨‹
    A1[readç³»ç»Ÿè°ƒç”¨] --> A2[DMA: ç£ç›˜â†’å†…æ ¸]
    A2 --> A3[CPU: å†…æ ¸â†’ç”¨æˆ·]
    A3 --> A4[writeç³»ç»Ÿè°ƒç”¨]
    A4 --> A5[CPU: ç”¨æˆ·â†’å†…æ ¸]
    A5 --> A6[DMA: å†…æ ¸â†’ç½‘å¡]
    end
  
    subgraph Nettyé›¶æ‹·è´æµç¨‹
    B1[transferToè°ƒç”¨] --> B2[DMA: ç£ç›˜â†’å†…æ ¸]
    B2 --> B3[å†…æ ¸å†…éƒ¨ä¼ è¾“]
    B3 --> B4[DMA: å†…æ ¸â†’ç½‘å¡]
    end
  
    Start --> ä¼ ç»Ÿ
```